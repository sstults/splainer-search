'use strict';

import { queryTemplateSvc } from './queryTemplateSvc.js';

// Service implementation
export function algoliaSearcherPreprocessorSvc() {
  const self = this;
  self.prepare = prepare;

  const replaceQuery = function(qOption, args, queryText) {
    // Allows full override of query if a JSON friendly format is sent in
    if (queryText instanceof Object) {
      return queryText;
    } else {
      if (queryText) {
        queryText = queryText.replace(/\\/g, '\\\\');
        queryText = queryText.replace(/"/g, '\\"');
      }
      return queryTemplateSvc().hydrate(args, queryText, {qOption: qOption, encodeURI: false, defaultKw: '""'});
    }
  };

  const preparePostRequest = function (searcher) {
    const queryDsl = replaceQuery(searcher.config.qOption, searcher.args, searcher.queryText);
    searcher.queryDsl = queryDsl;
  };

  function prepare(searcher) {
    if (searcher.config.apiMethod === 'POST') {
      preparePostRequest(searcher);
    } else if (searcher.config.apiMethod === 'GET') {
      throw Error('GET is not supported by Algolia');
    }
  }
}
